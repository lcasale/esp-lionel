substitutions:
  friendly_name: "ESP Lionel"

esphome:
  name: esp-lionel-node
  friendly_name: ${friendly_name}

esp32:
  board: esp32dev
  framework:
    type: esp-idf
    version: recommended

# Import the TMCC external component from GitHub
external_components:
  - source:
      type: git
      url: https://github.com/lcasale/esp-lionel
      ref: main
    components: [tmcc]

logger:
  level: DEBUG

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  min_auth_mode: "WPA2"
  ap:
    ssid: "${friendly_name} Fallback"
    password: !secret ap_password

api:
  encryption:
    key: !secret api_encryption_key

web_server:
  port: 80
  auth:
    username: !secret web_server_username
    password: !secret web_server_password

ota:
  - platform: esphome
    password: !secret ota_password

# UART used to talk to the TMCC base (TMCC1 uses 9600 8N1)
# 
# TROUBLESHOOTING:
# ----------------
# If the train doesn't respond to commands:
# 
# 1. FIRST: Check if you even need the MAX3232!
#    If your Raspberry Pi + USB-to-serial works WITHOUT a MAX3232, then
#    your TMCC base likely expects TTL (3.3V/5V) levels, NOT RS-232.
#    In that case, connect ESP32 TX (GPIO23) directly to TMCC RX pin.
#
# 2. If using MAX3232 with inverted signals, try these pin configs:
#    Option A: Standard (default)
#      tx_pin: GPIO23
#    Option B: Inverted TX (some RS-232 adapters need this)
#      tx_pin:
#        number: GPIO23
#        inverted: true
#
# 3. Try swapping TX/RX if nothing works
#
# 4. Enable UART debug to see what's actually being sent
uart:
  - id: tmcc_uart
    tx_pin: GPIO23
    rx_pin: GPIO22
    baud_rate: 9600
    parity: NONE
    stop_bits: 1
    debug:
      direction: TX
      dummy_receiver: true
      after:
        bytes: 3
      sequence:
        - lambda: UARTDebug::log_hex(direction, bytes, ' ');

# TMCC Controller configuration
tmcc:
  uart_id: tmcc_uart
  # Diagnostic test button - sends test pattern for UART debugging
  test_button:
    name: "${friendly_name} UART Test"
  engine:
    address: 1
    max_speed: 18
    speed:
      name: "${friendly_name} Speed"
    direction:
      name: "${friendly_name} Direction"
    horn:
      name: "${friendly_name} Horn"
    bell:
      name: "${friendly_name} Bell"
    front_coupler:
      name: "${friendly_name} Front Coupler"
    rear_coupler:
      name: "${friendly_name} Rear Coupler"
    boost:
      name: "${friendly_name} Boost"
    brake:
      name: "${friendly_name} Brake"
